---
import { siteConfig } from "../config";
import AboutContent from "./TerminalContent/AboutContent.astro";
import ExperienceContent from "./TerminalContent/ExperienceContent.astro";
import ProjectsContent from "./TerminalContent/ProjectsContent.astro";
import EducationContent from "./TerminalContent/EducationContent.astro";
import ConnectContent from "./TerminalContent/ConnectContent.astro";

const hasProjects = siteConfig.projects && siteConfig.projects.length > 0;
const hasExperience = siteConfig.experience && siteConfig.experience.length > 0;
const hasEducation = siteConfig.education && siteConfig.education.length > 0;
const hasResume = siteConfig.resume;
---

<div class="interactive-terminal">
  <div class="terminal-window">
    
    <div class="terminal-body">
      <!-- Root directory listing -->
      <div id="root-content" class="terminal-content">
        <div class="terminal-line">
          <span class="prompt">portfolio@ryandielhenn:~$</span>
          <span class="command" id="main-command"></span>
        </div>
        
        <div class="file-listing" id="file-listing" style="display: none;">
          <div class="file-item" data-folder="about">
            <span class="permissions">drwxr-xr-x</span>
            <span class="size">2.1K</span>
            <span class="date">Sep 14</span>
            <span class="name">about/</span>
          </div>
          
          {hasExperience && (
            <div class="file-item" data-folder="experience">
              <span class="permissions">drwxr-xr-x</span>
              <span class="size">4.2K</span>
              <span class="date">Sep 14</span>
              <span class="name">experience/</span>
            </div>
          )}
          
          {hasProjects && (
            <div class="file-item" data-folder="projects">
              <span class="permissions">drwxr-xr-x</span>
              <span class="size">3.8K</span>
              <span class="date">Sep 14</span>
              <span class="name">projects/</span>
            </div>
          )}
          
          {hasEducation && (
            <div class="file-item" data-folder="education">
              <span class="permissions">drwxr-xr-x</span>
              <span class="size">1.9K</span>
              <span class="date">Sep 14</span>
              <span class="name">education/</span>
            </div>
          )}
          
          <div class="file-item" data-folder="connect">
            <span class="permissions">drwxr-xr-x</span>
            <span class="size">2.8K</span>
            <span class="date">Sep 14</span>
            <span class="name">connect/</span>
          </div>
          
          {hasResume && (
            <div class="file-item" data-resume>
              <span class="permissions">-rw-r--r--</span>
              <span class="size">245K</span>
              <span class="date">Sep 14</span>
              <span class="name">resume.pdf</span>
            </div>
          )}
        </div>
        
        <div class="terminal-line" id="second-prompt" style="display: none;">
          <span class="prompt">portfolio@ryandielhenn:~$</span>
          <span class="cursor">_</span>
        </div>
      </div>

      <!-- Content sections -->
      <AboutContent />
      <ExperienceContent />
      <ProjectsContent />
      <EducationContent />
      <ConnectContent />
    </div>
  </div>
</div>

<style>
  @import "../styles/terminal.css";
</style>

<script>
  // Initialize file item click handlers
  function initFileItemHandlers() {
    const fileItems = document.querySelectorAll('.file-item');
    
    fileItems.forEach(item => {
      // Remove existing listeners to prevent duplicates
      item.removeEventListener('click', handleFileItemClick);
      item.addEventListener('click', handleFileItemClick);
    });
  }

  // Handle file item clicks
  function handleFileItemClick(e: Event) {
    const item = e.currentTarget as HTMLElement;
    const folder = item.getAttribute('data-folder');
    const isResume = item.hasAttribute('data-resume');
    
    if (isResume) {
      // Handle resume download
      e.preventDefault();
      const link = document.createElement('a');
      link.href = '/ryan_dielhenn_resume.pdf';
      link.download = 'Ryan_Dielhenn_Resume.pdf';
      link.target = '_blank';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      // Visual feedback
      item.style.transform = 'scale(0.95)';
      setTimeout(() => {
        item.style.transform = '';
      }, 150);
    } else if (folder) {
      // Navigate into folder
      navigateToFolder(folder);
    }
  }

  // Function to show content based on folder name (used by both navigation and history)
  function showContent(folderName: string | null, addToHistory: boolean = true) {
    // Hide all content sections
    const allContents = document.querySelectorAll('.terminal-content');
    allContents.forEach(content => {
      content.classList.add('hidden');
    });

    if (folderName) {
      // Show the selected folder content
      const targetContent = document.getElementById(`${folderName}-content`);
      if (targetContent) {
        targetContent.classList.remove('hidden');
        
        if (addToHistory) {
          // Push state to browser history
          window.history.pushState({ folder: folderName }, '', `#${folderName}`);
        }
        
        // Scroll to top of terminal
        const terminalBody = document.querySelector('.terminal-body');
        if (terminalBody) {
          terminalBody.scrollTop = 0;
        }
      }
    } else {
      // Show root content
      const rootContent = document.getElementById('root-content');
      if (rootContent) {
        rootContent.classList.remove('hidden');
        
        if (addToHistory) {
          // Push state to browser history for root (remove hash from URL)
          window.history.pushState({ folder: null }, '', window.location.pathname);
        }
        
        // Scroll to top of terminal
        const terminalBody = document.querySelector('.terminal-body');
        if (terminalBody) {
          terminalBody.scrollTop = 0;
        }
      }
    }
  }

  // Handle browser back/forward buttons
  window.addEventListener('popstate', (event) => {
    const folder = event.state?.folder;
    const hash = window.location.hash.slice(1); // Get current hash from URL
    
    // Use hash from URL if state is null (handles direct navigation)
    const targetFolder = folder !== undefined ? folder : (hash || null);
    showContent(targetFolder, false); // Don't add to history since we're already navigating
  });

  document.addEventListener('DOMContentLoaded', () => {
    // Initialize file item handlers (will be re-initialized when file listing appears)
    initFileItemHandlers();

    // Add event listeners for connect items
    const connectItems = document.querySelectorAll('.connect-item');
    connectItems.forEach(item => {
      item.addEventListener('click', (e) => {
        const link = item.getAttribute('data-link');
        if (link) {
          if (link.startsWith('mailto:')) {
            // Handle email link
            window.location.href = link;
          } else {
            // Handle external links (LinkedIn, GitHub)
            window.open(link, '_blank', 'noopener,noreferrer');
          }
        }
      });
    });

    // Check if there's a hash in the URL on page load
    const hash = window.location.hash.slice(1); // Remove the #
    if (hash) {
      // Show content for the hash without adding to history (replace current state)
      showContent(hash, false);
      window.history.replaceState({ folder: hash }, '', `#${hash}`);
    } else {
      // Initialize root state in history (root content should already be visible)
      window.history.replaceState({ folder: null }, '', window.location.pathname);
    }

  });

  function navigateToFolder(folderName: string) {
    showContent(folderName, true);
  }

  // Typing animation for main command
  function typeCommand(element: HTMLElement, text: string, speed: number = 80) {
    element.textContent = '';
    element.classList.add('typing');
    
    let i = 0;
    function type() {
      if (i < text.length) {
        element.textContent += text.charAt(i);
        i++;
        setTimeout(type, speed);
      } else {
        element.classList.remove('typing');
        element.classList.add('typing-complete');
        
        // Show file listing after command finishes typing
        const fileListing = document.getElementById('file-listing');
        if (fileListing) {
          setTimeout(() => {
            fileListing.style.display = 'block';
            
            // Animate each file item appearing one by one
            const fileItems = fileListing.querySelectorAll('.file-item');
            fileItems.forEach((item, index) => {
              setTimeout(() => {
                item.classList.add('animate-in');
              }, index * 100); // 100ms delay between each item
            });
            
            // Re-initialize file item click handlers after animation
            setTimeout(() => {
              initFileItemHandlers();
            }, fileItems.length * 100 + 100);
            
            // Show second prompt after all file items have animated in
            setTimeout(() => {
              const secondPrompt = document.getElementById('second-prompt');
              if (secondPrompt) {
                secondPrompt.style.display = 'block';
              }
            }, fileItems.length * 100 + 400);
          }, 200);
        }
      }
    }
    
    type();
  }

  // Initialize typing animation on page load
  document.addEventListener('DOMContentLoaded', function() {
    const mainCommand = document.getElementById('main-command');
    if (mainCommand) {
      // Start typing animation after a short delay
      setTimeout(() => {
        typeCommand(mainCommand, 'ls -la', 80);
      }, 500);
    }
  });

  // Make functions globally available
  (window as any).navigateToFolder = navigateToFolder;
</script>
